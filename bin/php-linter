#!/usr/bin/env php
<?php

/**
 * PHP Linter and Metrics Analyzer Execution Script.
 *
 * Scans the current repository for PHP files and performs static analysis
 * and linting checks. It first runs metrics analysis to evaluate code quality
 * indicators, followed by linting to enforce coding standards.
 *
 * ## Preconditions
 * - Must be run from the repository root directory to correctly locate `vendor/autoload.php` and configuration files.
 *
 * ## Arguments
 * This script accepts no command-line arguments. It automatically detects
 * PHP files within the repository.
 *
 * @package DouglasGreen\PhpLinter
 *
 * @example
 * ```bash
 * # Execute from the repository root
 * php bin/php-linter
 * ```
 */

declare(strict_types=1);

use DouglasGreen\PhpLinter\ComposerFile;
use DouglasGreen\PhpLinter\Config;
use DouglasGreen\PhpLinter\IgnoreList;
use DouglasGreen\PhpLinter\IssueHolderTrait;
use DouglasGreen\PhpLinter\Linter;
use DouglasGreen\PhpLinter\Metrics\Analyzer;
use DouglasGreen\PhpLinter\Metrics\CacheManager;
use DouglasGreen\PhpLinter\Metrics\IssueHolderTrait as MetricsIssueHolderTrait;
use DouglasGreen\PhpLinter\Metrics\MetricChecker;
use DouglasGreen\PhpLinter\Repository;

$currentDir = getcwd();
if ($currentDir === false) {
    throw new Exception('Unable to get working dir');
}

require_once $currentDir . '/vendor/autoload.php';

// Load configuration
$config = new Config($currentDir);
$ignoreIssues = $config->getIgnoreIssues();

// Set ignore issues globally for all IssueHolderTrait users
IssueHolderTrait::setIgnoreIssues($ignoreIssues);
MetricsIssueHolderTrait::setIgnoreIssues($ignoreIssues);
MetricChecker::setIgnoreIssues($ignoreIssues);

$repository = new Repository();
$phpFiles = $repository->getPhpFiles();
$repository->printIssues();

// 1. Run Metrics
$cache = new CacheManager($currentDir);
$ignoreList = new IgnoreList($currentDir);
$analyzer = new Analyzer($currentDir, $cache, $ignoreList);
$analyzer->run($phpFiles);

// 2. Run Linter
$composerFile = new ComposerFile($currentDir . '/composer.json');
$ignoreList = new IgnoreList($currentDir);
$linter = new Linter($composerFile, $ignoreList);
$linter->run($phpFiles);

