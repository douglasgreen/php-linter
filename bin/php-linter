#!/usr/bin/env php
<?php

declare(strict_types=1);

use DouglasGreen\PhpLinter\ComposerFile;
use DouglasGreen\PhpLinter\IgnoreList;
use DouglasGreen\PhpLinter\Linter;
use DouglasGreen\PhpLinter\Metrics\Analyzer;
use DouglasGreen\PhpLinter\Metrics\CacheManager;
use DouglasGreen\PhpLinter\Metrics\IgnoreList as MetricsIgnoreList;
use DouglasGreen\PhpLinter\Repository;

// Must be run in repository root directory.
$currentDir = getcwd();
if ($currentDir === false) {
    throw new Exception('Unable to get working dir');
}

require_once $currentDir . '/vendor/autoload.php';

$repository = new Repository();
$phpFiles = $repository->getPhpFiles();
$repository->printIssues();

// 1. Run Linter
$composerFile = new ComposerFile($currentDir . '/composer.json');
$ignoreList = new IgnoreList($currentDir);
$linter = new Linter($composerFile, $ignoreList);
$linter->run($phpFiles);

// 2. Run Metrics
$cache = new CacheManager($currentDir);
$metricsIgnoreList = new MetricsIgnoreList($currentDir);
$analyzer = new Analyzer($currentDir, $cache, $metricsIgnoreList);
$analyzer->run($phpFiles);
